suite: Deployment CSI integration
templates:
  - deployment.yaml
  - configmap.yaml

tests:
  - it: renders successfully when CSI is enabled
    set:
      auth:
        enabled: true
        csisecretstore:
          enabled: true
          secretProviderClassName: "test-spc"
          mountPath: /mnt/secrets-store
    asserts:
      - isKind:
          of: Deployment
        template: deployment.yaml
      - hasDocuments:
          count: 1
        template: deployment.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: csi-secrets
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "test-spc"
        template: deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: csi-secrets
            mountPath: "/mnt/secrets-store"
            readOnly: true
        template: deployment.yaml
      - exists:
          path: spec.template.metadata.annotations["checksum/secretproviderclass"]
        template: deployment.yaml


  - it: renders successfully when CSI is disabled
    set:
      auth:
        enabled: true
        csisecretstore:
          enabled: false
    asserts:
      - isKind:
          of: Deployment
        template: templates/deployment.yaml
      - hasDocuments:
          count: 1
        template: templates/deployment.yaml
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: csi-secrets
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: csi-secrets
      - notExists:
          path: spec.template.metadata.annotations["checksum/secretproviderclass"]
