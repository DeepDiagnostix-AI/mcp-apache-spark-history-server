suite: test externalsecret
templates:
  - externalsecret.yaml

tests:
  - it: should not render when auth is disabled
    set:
      auth.enabled: false
      auth.externalsecret.create: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when externalsecret.create is false
    set:
      auth.enabled: true
      auth.externalsecret.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ExternalSecret with correct metadata and apiVersion
    set:
      auth.enabled: true
      auth.externalsecret.create: true
      auth.externalsecret.secretStoreRef.name: my-store
      auth.externalsecret.secretPath: my/secret
    asserts:
      - isKind:
          of: ExternalSecret
      - equal:
          path: apiVersion
          value: external-secrets.io/v1beta1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-mcp-apache-spark-history-server-auth
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should set secretStoreRef name and default kind
    set:
      auth.enabled: true
      auth.externalsecret.create: true
      auth.externalsecret.secretStoreRef.name: my-store
      auth.externalsecret.secretPath: my/secret
    asserts:
      - equal:
          path: spec.secretStoreRef.name
          value: my-store
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore

  - it: should default refreshInterval to 1h
    set:
      auth.enabled: true
      auth.externalsecret.create: true
      auth.externalsecret.secretStoreRef.name: my-store
      auth.externalsecret.secretPath: my/secret
    asserts:
      - equal:
          path: spec.refreshInterval
          value: "1h"

  - it: should set target name to the secretName
    set:
      auth.enabled: true
      auth.externalsecret.create: true
      auth.externalsecret.secretStoreRef.name: my-store
      auth.externalsecret.secretPath: my/secret
    asserts:
      - equal:
          path: spec.target.name
          value: RELEASE-NAME-mcp-apache-spark-history-server-auth

  - it: should map data keys to remoteRef properties and path
    set:
      auth.enabled: true
      auth.externalsecret.create: true
      auth.externalsecret.secretStoreRef.name: my-store
      auth.externalsecret.secretPath: my/secret
    asserts:
      - equal:
          path: spec.data[0].secretKey
          value: username
      - equal:
          path: spec.data[0].remoteRef.key
          value: my/secret
      - equal:
          path: spec.data[0].remoteRef.property
          value: username

      - equal:
          path: spec.data[1].secretKey
          value: password
      - equal:
          path: spec.data[1].remoteRef.key
          value: my/secret
      - equal:
          path: spec.data[1].remoteRef.property
          value: password

      - equal:
          path: spec.data[2].secretKey
          value: token
      - equal:
          path: spec.data[2].remoteRef.key
          value: my/secret
      - equal:
          path: spec.data[2].remoteRef.property
          value: token
